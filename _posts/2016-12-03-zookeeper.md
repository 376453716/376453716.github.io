---
layout:     post
title:      Zookeeper Start
subtitle:   
date:       2016-12-03
author:     Hao
catalog: true
tags:
    - zk
---
### zookeeper
zookeeper是一个分布式协调系统，可同时响应上万个请求。
分布式协调：分布式环境下，多个程序需要解决各种类型的协调问题，如：主从选举、服务注册发现、分布式锁、
#### feature
  - simple：ZooKeeper允许分布式进程通过共享层次命名空间相互协调。名称空间由znodes组成，类似于文件和目录。ZooKeeper数据保存在内存中，这意味着ZooKeeper可以获得高吞吐量和低延迟数。
  - replicated：集群通过复制实现高可用，客户端连接的服务出现故障时会自动切换
  - order：更新是有序的
  - fast：在读取比写入更常见的地方，它的性能最好

#### 数据模型和分层命名空间
  - namepsace中的每个节点都可以拥有与其相关的数据以及子节点
  - Znodes维护一个stat结构，该结构包含用于数据更改、ACL更改和时间戳的版本号，以允许缓存验证和协调更新。每次znode的数据发生变化，版本号就会增加。每当客户机检索数据时，它也会接收数据的版本。
  - 每个znode上的数据是按原子方式读写的
  - 瞬时节点：会话期间有效，会话结束节点被删除
  - 持久节点：一直有效
  - watch：可以监听节点，发送变化时通知客户端

#### Guarantees
- 顺序一致性——来自客户机的更新将按照发送的顺序应用。
- 原子性——更新成功或失败。没有部分结果。
- 单个系统映像——无论连接到哪个服务器，客户机都将看到相同的服务视图
- 可靠性——一旦应用了更新，它将从那时起一直持续到客户端重写更新。

#### Implementation
1. 所有服务器都可以响应读请求，总服务器负责更新操作
2. 主服务器更新后还未同步到从服务时，可以调用Sync，保证主从同步，读取到最新的数据
3. 服务端会返回zxid，表示目前更新的最高编号，如果客户端切换到了另外的服务器，通过比较服务器与客户端的zxid，可以保证看到的数据不会比之前的版本低
4. 重放日志：写入内存前先写入日志文件中避免数据丢失，周期性对内存数据做无锁快照，通过日志与快照保证可以恢复到最新状态

#### 应用场景
1. 领导者选举
  - 设置一个零时节点作为领导者节点，进程读取节点，如果成功则表示已有领导者，如果失败则尝试创建领导节点，创建成功则成为领导者，
  - 其他非领导者设置监听，观察到变化，读取新的领导者。
  - 领导者故障时，零时节点被删除，其他节点监听到变化，继续竞争成为新的领导
2. 配置管理
    - 进行动态配置管理，程序读取配置，并监听
    - 配置变更后通知客户端
3. 成员管理（如：服务注册发现）
  - 创建目录节点代表服务分组
  - 客户端注册到分组，创建临时子节点
  - 客户端断开时，临时节点删除
  - 监听分组目录可以获取节点创建于删除的通知
4. 锁管理
  - 创建锁节点
  - 每个进程在锁节点下创建临时自增节点，1，2，3...
  - 如果进程的序号是最小则获取到锁，否则监听锁，进行等待
  - 当锁释放后，监听进程获得通知，判断是否是最小序号
  - 释放锁，删除进程当前节点
5. 应用实例
  - Kafka：主从选举
  - spring cloud 服务注册
  - spring cloud 配置管理
