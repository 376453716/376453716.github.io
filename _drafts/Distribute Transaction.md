# 分布式事务(DTP)

### 两阶段提交
> 参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。

1. 前提：
    - 一个节点作为协调者(Coordinator)，其他节点作为参与者(Cohorts)。节点之间可以进行网络通信。
    - 所有节点采用预写式日志
    - 所有节点不会永久性损坏
2. 步骤：
    1. 第一阶段(Prepare)
    - 协调者询问参与者，执行预提交
    - 参与者执行预提交，写(redo/undo)日志
    - 根据各节点响应结果，决定是否进行第二阶段提交
    2. 第二阶段(commit)
    - 成功：当协调者节点从所有参与者节点获得的相应消息都为"同意"时：
        - 协调者发起正式提交请求
        - 参与者节点正式完成操作，释放事务占用的资源
        - 想协调者节点发送完成消息
        - 协调者节点收到参与者的'完成'消息，完成事务
    - 失败：如果任一参与者节点在第一阶段返回的响应消息为"终止"，或者超时无法获取所有参与者节点的响应消息时：
        - 协调者向参与者发起'回滚'请求
        - 参与者利用undo信息执行回滚，释放事务占用的资源
        - 参与者发送'回滚完成'消息
        - 协调者收到参与者'回滚完成'消息，取消事务
3. 缺点
    - 同步柱塞：执行中节点处于阻塞状态，会让所有参与者都在等待，代价大,业务规模越大，伸缩性差
    - 单点故障：协调者发生故障，无法继续完成事务操作
    - 不一致: 部分参与者收到commit请求的情况
    - 问题： 协调者发出commit后故障，唯一收到消息的参与者也故障，则事务状态无法确定

### 三阶段提交
CanCommit PreCommit DoCommit

### BASE理论
Base Available,Soft state,Eventual consistency

### CAP理论

### 可靠消息最终一致性
